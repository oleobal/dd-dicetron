#!/usr/bin/env python3
import discord
import os
import subprocess

client = discord.Client()

@client.event
async def on_ready():
    print('We have logged in as {0.user}'.format(client))

@client.event
async def on_message(message):
    if message.author == client.user:
        return

    if message.content.startswith('!r'):
        await message.channel.send(message.author.name+" "+roll_dice(message.content[2:]))

def roll_dice(expr):
    p = subprocess.run([os.environ["DD_DICE_PATH"], "--machine", expr], capture_output=True)
    if p.returncode == 0:
        lines= p.stdout.decode("utf-8").strip().split("\n")
        if len(lines[0])>500:
            lines[0]="[too long]"
        return "`"+lines[0]+"`: **"+lines[1]+"**"+(lines[2] if len(lines)>2 else "")
    else:
        return "Error"

def main():
    assert "DD_DISCORD_API_TOKEN" in os.environ
    assert "DD_DICE_PATH" in os.environ
    
    client.run(os.environ["DD_DISCORD_API_TOKEN"])

if __name__ == "__main__":
    main()